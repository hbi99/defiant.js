/* 
 * Defiant.js v0.9.1 
 * Smart templating with XSLT and XPath. 
 * http://defiantjs.com 
 * 
 * Copyright (c) 2013-2014, Hakan Bilgin <hbi@longscript.com> 
 * Licensed under the MIT License 
 */ 
"undefined"==typeof module&&(module={exports:void 0}),module.exports=Defiant=function(t){"use strict";function e(t){this._methods=[],this._owner=t,this._paused=!1}var n={env:"production",xml_decl:'<?xml version="1.0" encoding="utf-8"?>',namespace:'xmlns:d="defiant-namespace"',tabsize:4,is_safari:"undefined"!=typeof navigator?null!==navigator.userAgent.match(/safari/i):!1,render:function(t,e){var n,r,s=new XSLTProcessor,i=document.createElement("span"),a={match:"/"};switch(typeof t){case"object":this.extend(a,t),a.data||(a.data=e);break;case"string":a.template=t,a.data=e;break;default:throw"error"}if(a.data=JSON.toXML(a.data),this.xsl_template||this.gather_templates(),r=this.xsl_template.selectSingleNode('//xsl:template[@name="'+a.template+'"]'),r.setAttribute("match",a.match),s.importStylesheet(this.xsl_template),i.appendChild(s.transformToFragment(a.data,document)),r.removeAttribute("match"),this.is_safari){n=i.getElementsByTagName("script");for(var o=0,l=n.length;l>o;o++)n[o].defer=!0}return i.innerHTML},gather_templates:function(){for(var t=document.getElementsByTagName("script"),e="",n=0,r=t.length;r>n;n++)"defiant/xsl-template"===t[n].type&&(e+=t[n].innerHTML);this.xsl_template=this.xmlFromString('<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" '+this.namespace+">"+e.replace(/defiant:(\w+)/g,"$1")+"</xsl:stylesheet>")},xmlFromString:function(e){var n,r;return e=e.replace(/>\s{1,}</g,"><"),null===e.match(/<\?xml/)&&(e=this.xml_decl+e),t.DOMParser?(n=new DOMParser,r=n.parseFromString(e,"text/xml")):(r=new ActiveXObject("Microsoft.XMLDOM"),r.async="false",r.loadXML(e)),r},extend:function(t,e){for(var n in e)t[n]&&"object"==typeof e[n]?this.extend(t[n],e[n]):t[n]=e[n];return t},result:function(){var t=function(e){for(var n in t.prototype)t.prototype.hasOwnProperty(n)&&(e[n]=t.prototype[n]);return e};return t.prototype={sum:function(t){for(var e=0,n=this.length,r=0;n>e;e++)r+=+this[e][t];return r},avg:function(t){return this.sum(t)/this.length},sortAsc:function(t){return this.sort(function(e,n){return e[t]-n[t]})},sortDesc:function(t){return this.sort(function(e,n){return n[t]-e[t]})},min:function(t,e){for(var n=0,r=this.length,s=[];r>n;n++)s.push(this[n][t]);return Math[e||"min"].apply(null,s)},max:function(t){return this.min(t,"max")},add:function(t,e,n){for(var r=0,s=this.length,i="string"==typeof e;s>r;r++)switch(n){case"divide":this[r][t]/=i?this[r][e]:+e;break;case"multiply":this[r][t]*=i?this[r][e]:+e;break;case"subtract":this[r][t]-=i?this[r][e]:+e;break;default:this[r][t]+=i?this[r][e]:+e}return this},subtract:function(t,e){return this.add(t,e,"subtract")},divide:function(t,e){return this.add(t,e,"divide")},multiply:function(t,e){return this.add(t,e,"multiply")},each:function(t){for(var e=0,n=this.length;n>e;e++)t(this[e]);return this}},new t(arguments[0])},ajax:function(t){var s=n.ajax;for(var i in r.prototype)r.prototype.hasOwnProperty(i)&&(s[i]=r.prototype[i]);return s.queue=new e(s),s.load(t)}},r=function(){};return r.prototype={callback:function(t){return this.data=t,this.queue._paused=!1,this.queue.flush(),this},load:function(t){var e=function(){var e=document.getElementsByTagName("head").item(0),n=document.createElement("script");n.setAttribute("type","text/javascript"),n.setAttribute("charset","utf-8"),n.setAttribute("src",t+"&callback=Defiant.ajax.callback"),e.appendChild(n)};return e._paused=!0,this.queue.add(e),this},each:function(t){var e=this;return this.queue.add(function(){for(var n=0,r=e.res.length;r>n;n++)t.call(e,e.res[n])}),this},search:function(t){var e=this,n=function(){e.res=JSON.search(this.data,t)};return this.queue.add(n),this}},e.prototype={add:function(t){this._methods.push(t),this._paused||this.flush()},flush:function(){if(!this._paused)for(;this._methods[0];){var t=this._methods.shift();if(t.call(this._owner),t._paused){this._paused=!0;break}}}},n}(this),String.prototype.fill||(String.prototype.fill=function(t,e){var n=this;for(e=e||" ";t>n.length;n+=e);return n}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/gm,"")}),String.prototype.count_nl||(String.prototype.count_nl=function(){var t=this.match(/\n/g);return t?t.length:0}),String.prototype.notabs||(String.prototype.notabs=function(){return this.replace(/\t/g,"")}),"undefined"==typeof JSON&&(window.JSON={parse:function(sJSON){return eval("("+sJSON+")")},stringify:function(t){if(t instanceof Object){var e="";if(t.constructor===Array){for(var n=0;t.length>n;e+=this.stringify(t[n])+",",n++);return"["+e.substr(0,e.length-1)+"]"}if(t.toString!==Object.prototype.toString)return'"'+(""+t).replace(/"/g,"\\$&")+'"';for(var r in t)e+='"'+r.replace(/"/g,"\\$&")+'":'+this.stringify(t[r])+",";return"{"+e.substr(0,e.length-1)+"}"}return"string"==typeof t?'"'+t.replace(/"/g,"\\$&")+'"':t+""}}),JSON.toXML||(JSON.toXML=function(t){"use strict";var e={replace:function(t){for(var e in this)delete this[e];Defiant.extend(this,t)},to_xml:function(t){var e=this.hash_to_xml(null,t);return Defiant.xmlFromString(e)},hash_to_xml:function(t,e,n){var r,s,i,a,o,l,u=e.constructor===Array,c=[],h=[];for(r in e)if(s=e[r],(null===s||"NaN"==""+s)&&(s=null),a="@"===r.slice(0,1),o=n?t:r,o==+o&&e.constructor!==Object&&(o="d:item"),l=null===s?null:s.constructor,a)h.push(o.slice(1)+'="'+this.escape_xml(s)+'"'),"String"!==l.name&&h.push("d:"+o.slice(1)+'="'+l.name+'"');else if(null===s)c.push(this.scalar_to_xml(o,s));else switch(l){case Object:c.push(this.hash_to_xml(o,s));break;case Array:if(r===o){if(i=s.constructor===Array)for(var d=0,f=s.length;f>d;d++)s[d].constructor===Array&&(i=!0),i||s[d].constructor!==Object||(i=!0);c.push(this.scalar_to_xml(o,s,i));break}case String:"string"==typeof s&&(s=(""+s).replace(/\&/g,"&amp;"));case Number:case Boolean:"#text"===o&&"String"!==l.name&&h.push('d:constr="'+l.name+'"'),c.push(this.scalar_to_xml(o,s));break;default:throw"ERROR! "+r}return t||(t="d:data",h.push(Defiant.namespace),u&&h.push('d:constr="Array"')),null===t.match(/^(?!xml)[a-z_][\w\d.:]*$/i)&&(h.push('d:name="'+t+'"'),t="d:name"),n?c.join(""):"<"+t+(h.length?" "+h.join(" "):"")+(c.length?">"+c.join("")+"</"+t+">":"/>")},scalar_to_xml:function(t,e,n){var r,s,i="";return null===t.match(/^(?!xml)[a-z_][\w\d.:]*$/i)&&(i+=' d:name="'+t+'"',t="d:name",n=!1),(null===e||"NaN"==""+e)&&(e=null),null===e?"<"+t+' d:constr="null"/>':n?this.hash_to_xml(t,e,!0):(s=e.constructor,r=s===Array?this.hash_to_xml("d:item",e,!0):this.escape_xml(e),"String"!==s.name&&(i+=' d:constr="'+s.name+'"'),"#text"===t?this.escape_xml(e):"<"+t+i+">"+r+"</"+t+">")},escape_xml:function(t){return(t+"").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}},n=e.to_xml.call(e,t);return e.replace.call(t,n.documentElement.toJSON()),n}),JSON.search||(JSON.search=function(t,e,n){"use strict";var r,s,i,a,o,l,u=JSON.toXML(t),c=u.documentElement,h=u[n?"selectSingleNode":"selectNodes"](e),d=[],f=[],p=function(t){if(i===d[m].length)return t;switch(t.constructor){case Array:for(var e,n=0,r=t.length;r>n;n++)if(a.val===JSON.stringify(t[n],null,"	")&&d[m].length>i)return i++,a=d[m][i],p(t[n]);if(n===r){if(a.val===JSON.stringify(t,null,"	"))for(i++,a=d[m][i],n=0;r>n;n++)if(e=p(t[n]))return e;return t}break;default:if(o=d[m][i].node.nodeType,l=1===o?d[m][i].node.getAttribute("d:name"):!1,l=l||a.key,t=t[l],"object"!=typeof t)return i++,a=d[m][i],t;t.constructor===Object&&(i++,a=d[m][i])}return p(t)};for(n&&(h=[h]),m=0,g=h.length;g>m;m++)if(r=[],s=h[m],s!==c){for(;s!==c;)o=2===s.nodeType,r.push({node:s,key:(o?"@":"")+s.nodeName,val:o?s.value:s.toJSON("	")}),s=o?s.ownerElement:s.parentNode;d.push(r.reverse())}for(var m=0,g=d.length;g>m;m++)i=0,a=d[m][i],f.push(p(t));return this.trace=JSON.search.trace?JSON.mtrace(t,d):!1,Defiant.result(f)}),JSON.mtrace||(JSON.mtrace=function(t,e){"use strict";for(var n,r,s,i,a,o,l,u=[],c=JSON.stringify(t,null,"	").notabs(),h=0,d=e.length;d>h;h++){r=e[h],a=0,n=c,s=r.length,i=null===r[s-1].val.match(/[\{\}:\[\]]/g),i&&s--,r[0].val.notabs()!==c&&s>0&&(n=r[0].val.notabs(),a+=c.indexOf(n));for(var f=0,p=s;p>f;f++)a+=n.indexOf(r[f].val.notabs()),n=r[f].val.notabs();i&&(a+=n.indexOf('"'+r[f].key+'": ')),o=c.slice(0,a).count_nl()+1,l=r[i?s:s-1].val.count_nl(),u.push([o,l])}return u}),Document.selectNodes||(Document.prototype.selectNodes=function(t,e){e||(e=this),this.ns=this.createNSResolver(this.documentElement),this.qI=this.evaluate(t,e,this.ns,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);for(var n=[],r=0,s=this.qI.snapshotLength;s>r;r++)n.push(this.qI.snapshotItem(r));return n}),Document.selectSingleNode||(Document.prototype.selectSingleNode=function(t,e){return e||(e=this),this.xI=this.selectNodes(t,e),this.xI.length>0?this.xI[0]:null}),Node.selectNodes||(Node.prototype.selectNodes=function(t){return this.ownerDocument.selectNodes(t,this)}),Node.selectSingleNode||(Node.prototype.selectSingleNode=function(t){return this.ownerDocument.selectSingleNode(t,this)}),Node.xml||Node.prototype.__defineGetter__("xml",function(){var t=Defiant.tabsize,e=Defiant.xml_decl.toLowerCase(),n=new XMLSerializer,r=n.serializeToString(this);"development"!==Defiant.env&&(r=r.replace(/ \w+\:d=".*?"| d\:\w+=".*?"/g,""));for(var s,i,a=r.trim().replace(/(>)\s*(<)(\/*)/g,"$1\n$2$3"),o=a.split("\n"),l=-1,u=0,c=o.length;c>u;u++)(0!==u||o[u].toLowerCase()!==e)&&(s=null!==o[u].match(/<[^\/]+>/g),i=null!==o[u].match(/<\/[\w\:]+>/g),null!==o[u].match(/<.*?\/>/g)&&(s=i=!0),s&&l++,o[u]="".fill(l,"	")+o[u],s&&i&&l--,!s&&i&&l--);return o.join("\n").replace(/\t/g,"".fill(t," "))}),Node.toJSON||(Node.prototype.toJSON=function(t){"use strict";var e=function(t){var n,r,s,i,a,o,l={};switch(t.nodeType){case 1:r=t.getAttribute("d:constr"),"Array"===r&&(l=[]),n=t.attributes;for(var u,c=0,h=n.length;h>c;c++)u=n.item(c),null===u.nodeName.match(/\:d|d\:/g)&&(r=t.getAttribute("d:"+u.nodeName),o=r?window[r]("false"===u.nodeValue?"":u.nodeValue):u.nodeValue,l["@"+u.nodeName]=o);break;case 3:r=t.parentNode.getAttribute("d:type"),o=r?window[r]("false"===t.nodeValue?"":t.nodeValue):t.nodeValue,l=o}if(t.hasChildNodes())for(var d=0,f=t.childNodes.length;f>d;d++)if(s=t.childNodes.item(d),i=s.nodeName,n=t.attributes,"d:name"===i&&(i=s.getAttribute("d:name")),"#text"===i)a=t.getAttribute("d:constr"),o="Boolean"===a&&"false"===s.textContent?"":s.textContent,a||n.length?a&&1===n.length?l=window[a](o):t.hasChildNodes()?3>n.length?l=a?window[a](o):o:l[i]=a?window[a](o):o:l[i]=a?window[a](o):o:l=o;else{if(l[i]){l[i].push?l[i].push(e(s)):l[i]=[l[i],e(s)];continue}switch(a=s.getAttribute("d:constr")){case"null":l.push?l.push(null):l[i]=null;break;case"Array":s.parentNode.firstChild===s&&"Array"===s.getAttribute("d:constr")&&"d:item"!==i?l[i]=[e(s)]:l.push?l.push(e(s)):l[i]=e(s);break;case"String":case"Number":case"Boolean":o="Boolean"===a&&"false"===s.textContent?"":s.textContent,l.push?l.push(window[a](o)):l[i]=e(s);break;default:l.push?l.push(e(s)):l[i]=e(s)}}return l},n=9===this.nodeType?this.documentElement:this,r=e(n),s=r[n.nodeName];return n===n.ownerDocument.documentElement&&s&&s.constructor===Array&&(r=s),t&&"true"==""+t&&(t="	"),t?JSON.stringify(r,null,t):r}),"undefined"!=typeof jQuery&&function(t){"use strict";t.fn.defiant=function(t,e){return this.html(Defiant.render(t,e)),this}}(jQuery);