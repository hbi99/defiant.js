/* 
 * Defiant.js v0.8.7 
 * Smart templating with XSLT and XPath. 
 * http://defiantjs.com 
 * 
 * Copyright (c) 2013-2014, Hakan Bilgin <hbi@longscript.com> 
 * Licensed under the MIT License 
 */ 
(function(t,e){"use strict";var n={env:"production",xml_decl:'<?xml version="1.0" encoding="utf-8"?>',namespace:'xmlns:d="defiant-namespace"',tabsize:4,is_safari:null!==navigator.userAgent.match(/safari/i),render:function(t,n){var r,s,o=new XSLTProcessor,i=e.createElement("span"),a={match:"/"};switch(typeof t){case"object":this.extend(a,t),a.data||(a.data=n);break;case"string":a.template=t,a.data=n;break;default:throw"error"}if(a.data=JSON.toXML(a.data),this.xsl_template||this.gather_templates(),s=this.xsl_template.selectSingleNode('//xsl:template[@name="'+a.template+'"]'),s.setAttribute("match",a.match),o.importStylesheet(this.xsl_template),i.appendChild(o.transformToFragment(a.data,e)),s.removeAttribute("match"),this.is_safari){r=i.getElementsByTagName("script");for(var l=0,u=r.length;u>l;l++)r[l].defer=!0}return i.innerHTML},gather_templates:function(){for(var t=e.getElementsByTagName("script"),n="",r=0,s=t.length;s>r;r++)"defiant/xsl-template"===t[r].type&&(n+=t[r].innerHTML);this.xsl_template=this.xmlFromString('<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" '+this.namespace+">"+n.replace(/defiant:(\w+)/g,"$1")+"</xsl:stylesheet>")},xmlFromString:function(e){var n,r;return e=e.replace(/>\s{1,}</g,"><"),null===e.match(/<\?xml/)&&(e=this.xml_decl+e),t.DOMParser?(n=new DOMParser,r=n.parseFromString(e,"text/xml")):(r=new ActiveXObject("Microsoft.XMLDOM"),r.async="false",r.loadXML(e)),r},extend:function(t,e){for(var n in e)t[n]&&"object"==typeof e[n]?this.extend(t[n],e[n]):t[n]=e[n];return t},result:function(){var t=function(e){var n=Object.create(Array.prototype);for(var r in t.prototype)t.prototype.hasOwnProperty(r)&&(n[r]=t.prototype[r]);for(var s=0,o=e.length;o>s;s++)n.push(e[s]);return n};return t.prototype={toArray:function(){return Array.prototype.slice.call(this,0)},sum:function(t){for(var e=0,n=this.length,r=0;n>e;e++)r+=+this[e][t];return r},avg:function(t){return this.sum(t)/this.length},min:function(t,e){for(var n=0,r=this.length,s=[];r>n;n++)s.push(this[n][t]);return Math[e||"min"].apply(null,s)},max:function(t){return this.min(t,"max")},add:function(t,e,n){for(var r=0,s=this.length,o="string"==typeof e;s>r;r++)switch(n){case"divide":this[r][t]/=o?this[r][e]:+e;break;case"multiply":this[r][t]*=o?this[r][e]:+e;break;case"subtract":this[r][t]-=o?this[r][e]:+e;break;default:this[r][t]+=o?this[r][e]:+e}return this},subtract:function(t,e){return this.add(t,e,"subtract")},divide:function(t,e){return this.add(t,e,"divide")},multiply:function(t,e){return this.add(t,e,"multiply")},each:function(t){for(var e=0,n=this.length;n>e;e++)t(this[e]);return this}},new t(arguments[0])}};t.Defiant=n})(window,document),String.prototype.fill||(String.prototype.fill=function(t,e){var n=this;for(e=e||" ";t>n.length;n+=e);return n}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/gm,"")}),String.prototype.count_nl||(String.prototype.count_nl=function(){var t=this.match(/\n/g);return t?t.length:0}),String.prototype.notabs||(String.prototype.notabs=function(){return this.replace(/\t/g,"")}),Document.selectNodes||(Document.prototype.selectNodes=function(t,e){e||(e=this),this.ns=this.createNSResolver(this.documentElement),this.qI=this.evaluate(t,e,this.ns,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);for(var n=[],r=0,s=this.qI.snapshotLength;s>r;r++)n.push(this.qI.snapshotItem(r));return n}),Node.selectNodes||(Node.prototype.selectNodes=function(t){return this.ownerDocument.selectNodes(t,this)}),Document.selectSingleNode||(Document.prototype.selectSingleNode=function(t,e){return e||(e=this),this.xI=this.selectNodes(t,e),this.xI.length>0?this.xI[0]:null}),Node.selectSingleNode||(Node.prototype.selectSingleNode=function(t){return this.ownerDocument.selectSingleNode(t,this)}),Node.xml||Node.prototype.__defineGetter__("xml",function(){var t=Defiant.tabsize,e=Defiant.xml_decl.toLowerCase(),n=new XMLSerializer,r=n.serializeToString(this);"development"!==Defiant.env&&(r=r.replace(/ \w+\:d=".*?"| d\:\w+=".*?"/g,""));for(var s,o,i=r.trim().replace(/(>)\s*(<)(\/*)/g,"$1\n$2$3"),a=i.split("\n"),l=-1,u=0,c=a.length;c>u;u++)(0!==u||a[u].toLowerCase()!==e)&&(s=null!==a[u].match(/<[^\/]+>/g),o=null!==a[u].match(/<\/[\w\:]+>/g),null!==a[u].match(/<.*?\/>/g)&&(s=o=!0),s&&l++,a[u]="".fill(l,"	")+a[u],s&&o&&l--,!s&&o&&l--);return a.join("\n").replace(/\t/g,"".fill(t," "))}),Node.text||(Node.prototype.__defineGetter__("text",function(){return this.textContent}),Node.prototype.__defineSetter__("text",function(t){this.textContent=t})),Node.toJSON||(Node.prototype.toJSON=function(t){"use strict";var e=function(t){var n,r,s,o,i,a,l={};switch(t.nodeType){case 1:r=t.getAttribute("d:constr"),"Array"===r&&(l=[]),n=t.attributes;for(var u,c=0,h=n.length;h>c;c++)u=n.item(c),null===u.nodeName.match(/\:d|d\:/g)&&(r=t.getAttribute("d:"+u.nodeName),a=r?window[r]("false"===u.nodeValue?"":u.nodeValue):u.nodeValue,l["@"+u.nodeName]=a);break;case 3:r=t.parentNode.getAttribute("d:type"),a=r?window[r]("false"===t.nodeValue?"":t.nodeValue):t.nodeValue,l=a}if(t.hasChildNodes())for(var f=0,p=t.childNodes.length;p>f;f++)if(s=t.childNodes.item(f),o=s.nodeName,n=t.attributes,"#text"===o)i=t.getAttribute("d:constr"),a="Boolean"===i&&"false"===s.textContent?"":s.textContent,i||n.length?i&&1===n.length?l=window[i](a):l[o]=i?window[i](a):a:l=a;else{if(l[o]){l[o].push?l[o].push(e(s)):l[o]=[l[o],e(s)];continue}switch(i=s.getAttribute("d:constr")){case"null":l.push?l.push(null):l[o]=null;break;case"Array":s.parentNode.firstChild===s&&"Array"===s.getAttribute("d:constr")&&"item"!==o?l[o]=[e(s)]:l.push?l.push(e(s)):l[o]=e(s);break;case"String":case"Number":case"Boolean":a="Boolean"===i&&"false"===s.textContent?"":s.textContent,l.push?l.push(window[i](a)):l[o]=e(s);break;default:l.push?l.push(e(s)):l[o]=e(s)}}return l},n=9===this.nodeType?this.documentElement:this,r=e(n),s=r[n.nodeName];return n===n.ownerDocument.documentElement&&s&&s.constructor===Array&&(r=s),t&&"true"==""+t&&(t="	"),t?JSON.stringify(r,null,t):r}),window.JSON||(window.JSON={parse:function(sJSON){return eval("("+sJSON+")")},stringify:function(t){if(t instanceof Object){var e="";if(t.constructor===Array){for(var n=0;t.length>n;e+=this.stringify(t[n])+",",n++);return"["+e.substr(0,e.length-1)+"]"}if(t.toString!==Object.prototype.toString)return'"'+(""+t).replace(/"/g,"\\$&")+'"';for(var r in t)e+='"'+r.replace(/"/g,"\\$&")+'":'+this.stringify(t[r])+",";return"{"+e.substr(0,e.length-1)+"}"}return"string"==typeof t?'"'+t.replace(/"/g,"\\$&")+'"':t+""}}),JSON.toXML||(JSON.toXML=function(t){"use strict";var e={repl:function(t){for(var e in this)delete this[e];Defiant.extend(this,t)},to_xml:function(t){var e=this.hash_to_xml(null,t);return Defiant.xmlFromString(e)},hash_to_xml:function(t,e,n){var r,s,o,i,a,l,u=e.constructor===Array,c=[],h=[];for(r in e)if(s=e[r],(null===s||"NaN"==""+s)&&(s=null),i="@"===r.slice(0,1),a=n?t:r,a=a==+a?"item":a,l=null===s?null:s.constructor,i)h.push(a.slice(1)+'="'+this.escape_xml(s)+'"'),"String"!==l.name&&h.push("d:"+a.slice(1)+'="'+l.name+'"');else if(null===s)c.push(this.scalar_to_xml(a,s));else switch(l){case Object:c.push(this.hash_to_xml(a,s));break;case Array:if(r===a){if(o=s.constructor===Array)for(var f=0,p=s.length;p>f;f++)s[f].constructor===Array&&(o=!0),o||s[f].constructor!==Object||(o=!0);c.push(this.scalar_to_xml(a,s,o));break}case String:"string"==typeof s&&(s=(""+s).replace(/\&/g,"&amp;"));case Number:case Boolean:"#text"===a&&"String"!==l.name&&h.push('d:constr="'+l.name+'"'),c.push(this.scalar_to_xml(a,s));break;default:throw"ERROR! "+r}return t||(t="d:data",h.push(Defiant.namespace),u&&h.push('d:constr="Array"')),n?c.join(""):"<"+t+(h.length?" "+h.join(" "):"")+(c.length?">"+c.join("")+"</"+t+">":"/>")},scalar_to_xml:function(t,e,n){var r,s,o;return(null===e||"NaN"==""+e)&&(e=null),null===e?"<"+t+' d:constr="null"/>':n?this.hash_to_xml(t,e,!0):(o=e.constructor,r=o===Array?this.hash_to_xml("item",e,!0):this.escape_xml(e),s=' d:constr="'+o.name+'"',"String"===o.name&&(s=""),"#text"===t?this.escape_xml(e):"<"+t+s+">"+r+"</"+t+">")},escape_xml:function(t){return(t+"").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}},n=e.to_xml.call(e,t);return e.repl.call(t,n.documentElement.toJSON()),n}),JSON.search||(JSON.search=function(t,e,n){"use strict";var r,s,o,i,a,l=JSON.toXML(t),u=l.documentElement,c=l[n?"selectSingleNode":"selectNodes"](e),h=[],f=[],p=function(t){if(o===h[d].length)return t;switch(t.constructor){case Array:for(var e,n=t.length,r=0;n>r;r++)if(i.val===JSON.stringify(t[r],null,"	")&&h[d].length>o)return o++,i=h[d][o],p(t[r]);if(r===n){if(i.val===JSON.stringify(t,null,"	"))for(o++,i=h[d][o],r=0;n>r;r++)if(e=p(t[r]))return e;return t}break;default:if(t=t[i.key],"object"!=typeof t)return o++,i=h[d][o],t;t.constructor===Object&&(o++,i=h[d][o])}return p(t)};for(n&&(c=[c]),d=0,m=c.length;m>d;d++)if(r=[],s=c[d],s!==u){for(;s!==u;)a=2===s.nodeType,r.push({node:s,key:(a?"@":"")+s.nodeName,val:a?s.value:s.toJSON("	")}),s=a?s.ownerElement:s.parentNode;h.push(r.reverse())}for(var d=0,m=h.length;m>d;d++)o=0,i=h[d][o],f.push(p(t));return this.trace=JSON.search.trace?JSON.mtrace(t,h):!1,console.log("RES:",f),Defiant.result(f)}),JSON.mtrace||(JSON.mtrace=function(t,e){"use strict";for(var n,r,s,o,i,a,l,u=[],c=JSON.stringify(t,null,"	").notabs(),h=0,f=e.length;f>h;h++){r=e[h],i=0,n=c,s=r.length,o=null===r[s-1].val.match(/[\{\}:\[\]]/g),o&&s--,r[0].val.notabs()!==c&&s>0&&(n=r[0].val.notabs(),i+=c.indexOf(n));for(var p=0,d=s;d>p;p++)i+=n.indexOf(r[p].val.notabs()),n=r[p].val.notabs();o&&(i+=n.indexOf('"'+r[p].key+'": ')),a=c.slice(0,i).count_nl()+1,l=r[o?s:s-1].val.count_nl(),u.push([a,l])}return u}),"undefined"!=typeof jQuery&&function(t){"use strict";t.fn.defiant=function(t,e){return this.html(Defiant.render(t,e)),this}}(jQuery);