/* 
 * Defiant.js v0.9.9 
 * Smart templating with XSLT and XPath. 
 * http://defiantjs.com 
 * 
 * Copyright (c) 2013-2014, Hakan Bilgin <hbi@longscript.com> 
 * Licensed under the MIT License 
 */ 
if("undefined"==typeof module)var module={exports:void 0};module.exports=Defiant=function(){"use strict";function a(a){this._methods=[],this._owner=a,this._paused=!1}var b={is_ie:/msie/i.test(navigator.userAgent),is_safari:/safari/i.test(navigator.userAgent),env:"production",xml_decl:'<?xml version="1.0" encoding="utf-8"?>',namespace:'xmlns:d="defiant-namespace"',tabsize:4,render:function(a,b){var c,d,e=new XSLTProcessor,f=document.createElement("span"),g={match:"/"};switch(typeof a){case"object":this.extend(g,a),g.data||(g.data=b);break;case"string":g.template=a,g.data=b;break;default:throw"error"}if(g.data=JSON.toXML(g.data),this.xsl_template||this.gather_templates(),d=this.node.selectSingleNode(this.xsl_template,'//xsl:template[@name="'+g.template+'"]'),d.setAttribute("match",g.match),e.importStylesheet(this.xsl_template),f.appendChild(e.transformToFragment(g.data,document)),d.removeAttribute("match"),this.is_safari){c=f.getElementsByTagName("script");for(var h=0,i=c.length;i>h;h++)c[h].defer=!0}return f.innerHTML},gather_templates:function(){for(var a=document.getElementsByTagName("script"),b="",c=0,d=a.length;d>c;c++)"defiant/xsl-template"===a[c].type&&(b+=a[c].innerHTML);this.xsl_template=this.xmlFromString('<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" '+this.namespace+">"+b.replace(/defiant:(\w+)/g,"$1")+"</xsl:stylesheet>")},xmlFromString:function(a){var b,c;return a=a.replace(/>\s{1,}</g,"><"),null===a.trim().match(/<\?xml/)&&(a=this.xml_decl+a),this.is_ie?(c=new ActiveXObject("Msxml2.DOMDocument.6.0"),c.loadXML(a)):(b=new DOMParser,c=b.parseFromString(a,"text/xml")),c},extend:function(a,b){for(var c in b)a[c]&&"object"==typeof b[c]?this.extend(a[c],b[c]):a[c]=b[c];return a},result:function(){var a=function(b){for(var c in a.prototype)a.prototype.hasOwnProperty(c)&&(b[c]=a.prototype[c]);return b};return a.prototype={sum:function(a){for(var b=0,c=this.length,d=0;c>b;b++)d+=+this[b][a];return d},avg:function(a){return this.sum(a)/this.length},sortAsc:function(a){return this.sort(function(b,c){return b[a]-c[a]})},sortDesc:function(a){return this.sort(function(b,c){return c[a]-b[a]})},min:function(a,b){for(var c=0,d=this.length,e=[];d>c;c++)e.push(this[c][a]);return Math[b||"min"].apply(null,e)},max:function(a){return this.min(a,"max")},add:function(a,b,c){for(var d=0,e=this.length,f="string"==typeof b;e>d;d++)switch(c){case"divide":this[d][a]/=f?this[d][b]:+b;break;case"multiply":this[d][a]*=f?this[d][b]:+b;break;case"subtract":this[d][a]-=f?this[d][b]:+b;break;default:this[d][a]+=f?this[d][b]:+b}return this},subtract:function(a,b){return this.add(a,b,"subtract")},divide:function(a,b){return this.add(a,b,"divide")},multiply:function(a,b){return this.add(a,b,"multiply")},each:function(a){for(var b=0,c=this.length;c>b;b++)a(this[b]);return this}},new a(arguments[0])},ajax:function(d,e){var f=b.ajax;for(var g in c.prototype)c.prototype.hasOwnProperty(g)&&(f[g]=c.prototype[g]);return f.queue=new a(f),d?f.load(d,e):f},node:{}},c=function(){};return c.prototype={callback:function(a){return this.data=a,this.queue._paused=!1,this.queue.flush(),this},wait:function(a){var b=this,c=function(){setTimeout(function(){b.queue._paused=!1,b.queue.flush()},a)};return c._paused=!0,this.queue.add(c),this},load:function(a,b){var c=function(){var b=document.getElementsByTagName("head").item(0),c=document.createElement("script"),d=a.indexOf("?")>-1?"&":"?";c.setAttribute("type","text/javascript"),c.setAttribute("charset","utf-8"),c.setAttribute("src",a+d+"callback=Defiant.ajax.callback"),b.appendChild(c)},d=function(){b(this.data)};return c._paused=!0,this.queue.add(c),b&&this.queue.add(d),this},each:function(a){var b=this;return this.queue.add(function(){if(!b.res.length)return a.call(b);for(var c=0,d=b.res.length;d>c;c++)a.call(b,b.res[c])}),this},search:function(a){var b=this,c=function(){b.res=JSON.search(b.data,a)};return this.queue.add(c),this}},a.prototype={add:function(a){this._methods.push(a),this._paused||this.flush()},flush:function(){if(!this._paused)for(;this._methods[0];){var a=this._methods.shift();if(a.call(this._owner),a._paused){this._paused=!0;break}}}},b}(this),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),String.prototype.fill||(String.prototype.fill=function(a,b){var c=this;for(b=b||" ";c.length<a;c+=b);return c}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/gm,"")}),String.prototype.count_nl||(String.prototype.count_nl=function(){var a=this.match(/\n/g);return a?a.length:0}),String.prototype.notabs||(String.prototype.notabs=function(){return this.replace(/\t/g,"")}),"undefined"==typeof JSON&&(window.JSON={parse:function(sJSON){return eval("("+sJSON+")")},stringify:function(a){if(a instanceof Object){var b="";if(a.constructor===Array){for(var c=0;c<a.length;b+=this.stringify(a[c])+",",c++);return"["+b.substr(0,b.length-1)+"]"}if(a.toString!==Object.prototype.toString)return'"'+a.toString().replace(/"/g,"\\$&")+'"';for(var d in a)b+='"'+d.replace(/"/g,"\\$&")+'":'+this.stringify(a[d])+",";return"{"+b.substr(0,b.length-1)+"}"}return"string"==typeof a?'"'+a.replace(/"/g,"\\$&")+'"':String(a)}}),JSON.toXML||(JSON.toXML=function(a){"use strict";var b={replace:function(a){for(var b in this)delete this[b];Defiant.extend(this,a)},to_xml:function(a){var b=this.hash_to_xml(null,a);return Defiant.xmlFromString(b)},hash_to_xml:function(a,b,c){var d,e,f,g,h,i,j,k=b.constructor===Array,l=[],m=[];for(d in b)if(e=b[d],(null===e||void 0===e||"NaN"===e.toString())&&(e=null),g="@"===d.slice(0,1),h=c?a:d,h==+h&&b.constructor!==Object&&(h="d:item"),null===e?(i=null,j=!1):(i=e.constructor,j=i.toString().match(/function (\w+)/i)[1]),g)m.push(h.slice(1)+'="'+this.escape_xml(e)+'"'),"String"!==j&&m.push("d:"+h.slice(1)+'="'+j+'"');else if(null===e)l.push(this.scalar_to_xml(h,e));else switch(i){case Function:break;case Object:l.push(this.hash_to_xml(h,e));break;case Array:if(d===h){if(f=e.constructor===Array)for(var n=0,o=e.length;o>n;n++)e[n].constructor===Array&&(f=!0),f||e[n].constructor!==Object||(f=!0);l.push(this.scalar_to_xml(h,e,f));break}case String:if("string"==typeof e&&(e=e.toString().replace(/\&/g,"&amp;")),"#text"===h){m.push('d:constr="'+j+'"'),l.push(this.escape_xml(e));break}case Number:case Boolean:if("#text"===h&&"String"!==j){m.push('d:constr="'+j+'"'),l.push(this.escape_xml(e));break}l.push(this.scalar_to_xml(h,e))}return a||(a="d:data",m.push(Defiant.namespace),k&&m.push('d:constr="Array"')),null===a.match(/^(?!xml)[a-z_][\w\d.:]*$/i)&&(m.push('d:name="'+a+'"'),a="d:name"),c?l.join(""):"<"+a+(m.length?" "+m.join(" "):"")+(l.length?">"+l.join("")+"</"+a+">":"/>")},scalar_to_xml:function(a,b,c){var d,e,f,g="";if(null===a.match(/^(?!xml)[a-z_][\w\d.:]*$/i)&&(g+=' d:name="'+a+'"',a="d:name",c=!1),(null===b||"NaN"===b.toString())&&(b=null),null===b)return"<"+a+' d:constr="null"/>';if(1===b.length&&b[0].constructor===Object){d=this.hash_to_xml(!1,b[0]);var h=d.match(/<(.+?)( .*?)>/),i=d.match(/<(.+?)( d:contr=".*?")>/);return h=null!==h?h[2].replace(/ xmlns\:d="defiant\-namespace"/,"").replace(/>/,"").replace(/"\/$/,'"'):"",i=null!==i?i[2]:"",d=d.match(/(<.+?>)(.*?)(<\/d:data>)/i),d=null!==d?d[2]:"","<"+a+h+" "+i+' d:type="ArrayItem">'+d+"</"+a+">"}return 0===b.length&&b.constructor===Array?"<"+a+' d:constr="Array"/>':c?this.hash_to_xml(a,b,!0):(e=b.constructor,f=e.toString().match(/function (\w+)/i)[1],d=e===Array?this.hash_to_xml("d:item",b,!0):this.escape_xml(b),g+=' d:constr="'+f+'"',"#text"===a?this.escape_xml(b):"<"+a+g+">"+d+"</"+a+">")},escape_xml:function(a){return String(a).replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}},c=b.to_xml.call(b,a);return b.replace.call(a,Defiant.node.toJSON(c.documentElement)),c}),JSON.search||(JSON.search=function(a,b,c){"use strict";var d,e,f,g,h,i,j=JSON.toXML(a),k=j.documentElement,l=Defiant.node[c?"selectSingleNode":"selectNodes"](j,b),m=[],n=[],o=function(a){if(f===m[p].length)return a;switch(a.constructor){case Array:for(var b,c=0,d=a.length;d>c;c++)if(g.val===JSON.stringify(a[c],null,"	")&&f<m[p].length)return f++,g=m[p][f],o(a[c]);if(c===d){if(g.val===JSON.stringify(a,null,"	"))for(f++,g=m[p][f],c=0;d>c;c++)if(b=o(a[c]))return b;return a}break;default:if(h=m[p][f].node.nodeType,i=1===h?m[p][f].node.getAttribute("d:name"):!1,i=i||g.key,a=a[i],"object"!=typeof a)return f++,g=m[p][f],a;a.constructor===Object&&(f++,g=m[p][f])}return o(a)};for(c&&(l=[l]),p=0,q=l.length;q>p;p++)if(d=[],e=l[p],e!==k){for(;e!==k;)h=2===e.nodeType,d.push({node:e,key:(h?"@":"")+e.nodeName,val:h?e.value:Defiant.node.toJSON(e,"	")}),e=h?e.ownerElement:e.parentNode;m.push(d.reverse())}for(var p=0,q=m.length;q>p;p++)f=0,g=m[p][f],n.push(o(a));return this.trace=JSON.search.trace?JSON.mtrace(a,m):!1,Defiant.result(n)}),JSON.mtrace||(JSON.mtrace=function(a,b){"use strict";for(var c,d,e,f,g,h,i,j=[],k=JSON.stringify(a,null,"	").notabs(),l=0,m=b.length;m>l;l++){d=b[l],g=0,c=k,e=d.length,f=null===d[e-1].val.match(/[\{\}:\[\]]/g),f&&e--,d[0].val.notabs()!==k&&e>0&&(c=d[0].val.notabs(),g+=k.indexOf(c));for(var n=0,o=e;o>n;n++)g+=c.indexOf(d[n].val.notabs()),c=d[n].val.notabs();f&&(g+=c.indexOf('"'+d[n].key+'": ')),h=k.slice(0,g).count_nl()+1,i=d[f?e:e-1].val.count_nl(),j.push([h,i])}return j}),Defiant.node.selectNodes=function(a,b){if(a.evaluate){for(var c=a.createNSResolver(a.documentElement),d=a.evaluate(b,a,c,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null),e=[],f=0,g=d.snapshotLength;g>f;f++)e.push(d.snapshotItem(f));return e}return a.selectNodes(b)},Defiant.node.selectSingleNode=function(a,b){if(a.evaluate){var c=this.selectNodes(a,b);return c.length>0?c[0]:null}return a.selectSingleNode(b)},Defiant.node.prettyPrint=function(a){var b,c,d=Defiant,e=d.tabsize,f=d.xml_decl.toLowerCase();d.is_ie?c=a.xml:(b=new XMLSerializer,c=b.serializeToString(a)),"development"!==d.env&&(c=c.replace(/ \w+\:d=".*?"| d\:\w+=".*?"/g,""));for(var g,h,i=c.trim().replace(/(>)\s*(<)(\/*)/g,"$1\n$2$3"),j=i.split("\n"),k=-1,l=0,m=j.length;m>l;l++)(0!==l||j[l].toLowerCase()!==f)&&(g=null!==j[l].match(/<[A-Za-z_\:]+.*?>/g),h=null!==j[l].match(/<\/[\w\:]+>/g),null!==j[l].match(/<.*?\/>/g)&&(g=h=!0),g&&k++,j[l]=String().fill(k,"	")+j[l],g&&h&&k--,!g&&h&&k--);return j.join("\n").replace(/\t/g,String().fill(e," "))},Defiant.node.toJSON=function(a,b){"use strict";var c=function(a){var b,d,e,f,g,h,i,j,k,l,m={};switch(a.nodeType){case 1:for(g=a.getAttribute("d:constr"),"Array"===g?m=[]:"String"===g&&""===a.textContent&&(m=""),b=a.attributes,j=0,k=b.length;k>j;j++)l=b.item(j),null===l.nodeName.match(/\:d|d\:/g)&&(g=a.getAttribute("d:"+l.nodeName),h=g&&"undefined"!==g?"null"===l.nodeValue?null:window[g]("false"===l.nodeValue?"":l.nodeValue):l.nodeValue,m["@"+l.nodeName]=h);break;case 3:d=a.parentNode.getAttribute("d:type"),h=d?window[d]("false"===a.nodeValue?"":a.nodeValue):a.nodeValue,m=h}if(a.hasChildNodes())for(j=0,k=a.childNodes.length;k>j;j++)if(e=a.childNodes.item(j),f=e.nodeName,b=a.attributes,"d:name"===f&&(f=e.getAttribute("d:name")),"#text"===f)g=a.getAttribute("d:constr"),"undefined"===g&&(g=void 0),i=e.textContent||e.text,h="Boolean"===g&&"false"===i?"":i,g||b.length?g&&1===b.length?m=window[g](h):a.hasChildNodes()&&b.length<3?m=g?window[g](h):h:m[f]=g?window[g](h):h:m=h;else{if(m[f]){m[f].push?m[f].push(c(e)):m[f]=[m[f],c(e)];continue}switch(g=e.getAttribute("d:constr")){case"null":m.push?m.push(null):m[f]=null;break;case"Array":e.parentNode.firstChild===e&&"Array"===g&&"d:item"!==f?"d:item"===f||"Array"===g?(h=c(e),m[f]=h.length?[h]:h):m[f]=c(e):m.push?m.push(c(e)):m[f]=c(e);break;case"String":case"Number":case"Boolean":i=e.textContent||e.text,h="Boolean"===g&&"false"===i?"":i,m.push?m.push(window[g](h)):m[f]=c(e);break;default:m.push?m.push(c(e)):m[f]=c(e)}}return 1===a.nodeType&&"ArrayItem"===a.getAttribute("d:type")&&(m=[m]),m},d=9===a.nodeType?a.documentElement:a,e=c(d),f=e[d.nodeName];return d===d.ownerDocument.documentElement&&f&&f.constructor===Array&&(e=f),b&&"true"===b.toString()&&(b="	"),b?JSON.stringify(e,null,b):e},"undefined"!=typeof jQuery&&!function(a){"use strict";a.fn.defiant=function(a,b){return this.html(Defiant.render(a,b)),this}}(jQuery);